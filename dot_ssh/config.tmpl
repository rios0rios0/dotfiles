{{- /* 
TODO: The IdentityFile logic is inverted on Android (uses private key), all other OSes use public key.
This is because on Android (Termux) only private keys are usable, while other platforms require public keys for SSH config.
*/ -}}
{{- $deviceName := default .chezmoi.hostname (env "CHEZMOI_DEVICE" | replaceAllRegex " " "-" | trim) | lower -}}
{{- $isAndroid := eq .chezmoi.os "android" -}}

###### VCS #######################################################################
{{- range (onepassword "Active SSHs" "personal" "my").fields -}}
  {{- if eq .type "REFERENCE" -}}
    {{- $sshName := onepasswordRead (printf "op://Private/%s/title" .value) "my" | trim -}}
    {{- $parts := split "@" $sshName -}}
    {{- $device := index $parts "_0" -}}
    {{- if eq $device $deviceName -}}
      {{- $sshAlias := onepasswordRead (printf "op://Private/%s/ssh alias" .value) "my" | trim -}}
      {{- $identityFile := "" -}}
      {{- if $isAndroid -}}
        {{- $identityFile = (print "~/.ssh/" $sshName) -}}
      {{- else -}}
        {{- $identityFile = (print "~/.ssh/" $sshName ".pub") -}}
      {{- end }}

Host github.com-{{ $sshAlias }}
  HostName github.com
  IdentityFile {{ $identityFile }}
  IdentitiesOnly yes

Host gitlab.com-{{ $sshAlias }}
  HostName gitlab.com
  IdentityFile {{ $identityFile }}
  IdentitiesOnly yes

# Azure DevOps
Host dev.azure.com-{{ $sshAlias }}
  HostName ssh.dev.azure.com
  IdentityFile {{ $identityFile }}
  IdentitiesOnly yes

Host visualstudio.com-{{ $sshAlias }}
  HostName vs-ssh.visualstudio.com
  IdentityFile {{ $identityFile }}
  IdentitiesOnly yes

# Atlassian
Host bitbucket.org-{{ $sshAlias }}
  HostName bitbucket.org
  IdentityFile {{ $identityFile }}
  IdentitiesOnly yes

    {{- end -}}
  {{- end -}}
{{- end }}

###### PEM #######################################################################
{{- range (onepassword "Active PEMs" "personal" "my").fields -}}
  {{- if eq .type "REFERENCE" -}}
    {{- $pemName := onepasswordRead (printf "op://Private/%s/title" .value) "my" | trim -}}
    {{- $parts := split "@" $pemName -}}
    {{- $device := index $parts "_0" -}}
    {{- if eq $device $deviceName -}}
      {{- $alias := onepasswordRead (printf "op://Private/%s/pem host alias" .value) "my" | trim -}}
      {{- $host := onepasswordRead (printf "op://Private/%s/pem host" .value) "my" | trim -}}
      {{- $user := onepasswordRead (printf "op://Private/%s/pem user" .value) "my" | trim -}}
      {{- $pemIdentityFile := (print "~/.ssh/" $pemName ".pem") -}}

Host {{ $alias }}
  HostName {{ $host }}
  User {{ $user }}
  IdentityFile {{ $pemIdentityFile }}
  IdentitiesOnly yes

    {{- end -}}
  {{- end -}}
{{- end }}
