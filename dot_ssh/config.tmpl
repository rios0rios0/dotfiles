{{- $deviceName := default .chezmoi.hostname (env "CHEZMOI_DEVICE" | replaceAllRegex " " "-" | trim) | lower -}}

###### VCS #######################################################################
{{- range (onepassword "Active SSHs" "personal" "my").fields -}}
  {{- if (eq .type "REFERENCE") -}}

    {{- /* Read full “device@account” title */ -}}
    {{- $sshName := onepasswordRead (list "op://Private/" .value "/title" | join "") "my" | trim -}}

    {{- /* Split into [device, account] */ -}}
    {{- $parts := split "@" $sshName -}}
    {{- $device := index $parts "_0" -}}

    {{- /* Only emit hosts for the current device */ -}}
    {{- if eq $device $deviceName -}}

      {{- $sshAlias := onepasswordRead (list "op://Private/" .value "/ssh alias" | join "") "my" | trim }}

Host github.com-{{ $sshAlias }}
  HostName github.com
  IdentityFile ~/.ssh/{{ $sshName }}.pub
  IdentitiesOnly yes

Host gitlab.com-{{ $sshAlias }}
  HostName gitlab.com
  IdentityFile ~/.ssh/{{ $sshName }}.pub
  IdentitiesOnly yes

# Azure DevOps
Host dev.azure.com-{{ $sshAlias }}
  HostName ssh.dev.azure.com
  IdentityFile ~/.ssh/{{ $sshName }}.pub
  IdentitiesOnly yes

Host visualstudio.com-{{ $sshAlias }}
  HostName vs-ssh.visualstudio.com
  IdentityFile ~/.ssh/{{ $sshName }}.pub
  IdentitiesOnly yes

# Atlassian
Host bitbucket.org-{{ $sshAlias }}
  HostName bitbucket.org
  IdentityFile ~/.ssh/{{ $sshName }}.pub
  IdentitiesOnly yes

    {{- end -}}
  {{- end -}}
{{- end }}

###### PEM #######################################################################
{{- range (onepassword "Active PEMs" "personal" "my").fields -}}
  {{- if (eq .type "REFERENCE") -}}

    {{- /* Read full “device@account” title */ -}}
    {{- $pemName := onepasswordRead (list "op://Private/" .value "/title" | join "") "my" | trim -}}

    {{- /* Split into [device, account] */ -}}
    {{- $parts := split "@" $pemName -}}
    {{- $device := index $parts "_0" -}}

    {{- /* Only emit hosts for the current device */ -}}
    {{- if eq $device $deviceName -}}

      {{- $alias := onepasswordRead (list "op://Private/" .value "/pem host alias" | join "") "my" | trim -}}
      {{- $host := onepasswordRead (list "op://Private/" .value "/pem host" | join "") "my" | trim -}}
      {{- $user := onepasswordRead (list "op://Private/" .value "/pem user" | join "") "my" | trim }}

Host {{ $alias }}
  HostName {{ $host }}
  User {{ $user }}
  IdentityFile ~/.ssh/{{ $pemName }}.pem
  IdentitiesOnly yes

    {{- end -}}
  {{- end -}}
{{- end }}
