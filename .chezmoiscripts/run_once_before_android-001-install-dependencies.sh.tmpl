#!{{ lookPath "bash" }}
#
# Refactored Android dependencies installation script
# Uses shared patterns and DRY principles
#

set -euo pipefail

# Include shared utility functions inline
command_exists() { command -v "$1" >/dev/null 2>&1; }
log() { echo "$(date '+%Y-%m-%d %H:%M:%S') [INFO] $*"; }
log_error() { echo "$(date '+%Y-%m-%d %H:%M:%S') [ERROR] $*" >&2; }
execute_command() { 
    local description="$1"; shift
    log "Executing: $description"
    if "$@"; then log "Success: $description"; else log_error "Failed: $description"; return 1; fi
}
is_tool_installed() { 
    local tool="$1" path="$2"
    [ -n "$path" ] && [ -f "$path" ] && { log "$tool already installed at $path"; return 0; }
    command_exists "$tool" && { log "$tool already available"; return 0; }
    return 1
}

# Configuration constants
readonly GO_VERSION="1.24.5"
readonly TERRAGRUNT_VERSION="0.76.6"
readonly NVM_VERSION="0.40.2"
readonly PYTHON_VERSION="3.13:latest"
readonly ONEPASSWORD_VERSION="2.31.1"

# Package definitions
readonly REQUIREMENTS=(
    "git" "curl" "zip" "unzip" "age" "eza" "sqlite" "vim" "neovim"
    "binutils-is-llvm" "bison" "make" "wget" "zsh" "ncurses-utils"
    "proot" "proot-distro" "file"
)
readonly HARDWARE=("htop" "screenfetch")
readonly UTILITIES=(
    "jq" "bat" "silversearcher-ag" "inotify-tools" "dos2unix" "expect"
    "which" "mlocate" "openssh"
)
readonly LANGUAGES=("golang" "rust" "nodejs" "python" "python-pip")

# Install packages function
install_packages() {
    local description="$1"; shift
    local packages=("$@")
    log "Installing $description: ${packages[*]}"
    execute_command "Install $description" apt install --no-install-recommends --yes "${packages[@]}"
}

# Installer functions with idempotency
install_oh_my_zsh() {
    [ -d "$HOME/.oh-my-zsh" ] && { log "Oh My Zsh already installed"; return 0; }
    execute_command "Install Oh My Zsh" \
        sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"
}

install_gvm() {
    command_exists go && { log "Go already available"; return 0; }
    [ -d "$HOME/.gvm" ] && { log "GVM already installed"; return 0; }
    execute_command "Install GVM" \
        bash -c "curl -s -S -L https://raw.githubusercontent.com/moovweb/gvm/master/binscripts/gvm-installer | bash"
    [ -f "$HOME/.gvm/scripts/gvm" ] && {
        source "$HOME/.gvm/scripts/gvm"
        execute_command "Install Go $GO_VERSION" gvm install "$GO_VERSION"
        execute_command "Use Go $GO_VERSION" gvm use "$GO_VERSION"
    }
}

install_wrapper() {
    execute_command "Install Alpine proot distribution" proot-distro install alpine
}

install_terra() {
    local terra_bin="/usr/bin/terra"
    proot-distro login alpine -- bash -c "[ -f '$terra_bin' ]" 2>/dev/null && { log "Terra already installed"; return 0; }
    
    local source_path="$HOME/Development/github.com/rios0rios0/terra"
    [ ! -d "$source_path" ] && {
        mkdir -p "$(dirname "$source_path")"
        execute_command "Clone terra repository" git clone https://github.com/rios0rios0/terra.git "$source_path"
    }
    
    (
        cd "$source_path" || exit 1
        export PATH="$PATH:$HOME/go/bin"
        execute_command "Build terra" make build
        execute_command "Copy terra to proot" proot-distro copy bin/terra alpine:/usr/bin
    )
}

install_terraform() {
    local terraform_bin="/usr/bin/terraform"
    proot-distro login alpine -- bash -c "[ -f '$terraform_bin' ]" 2>/dev/null && { log "Terraform already installed"; return 0; }
    
    execute_command "Install Terraform in proot" \
        proot-distro login alpine -- bash -c "
            wget https://releases.hashicorp.com/terraform/1.12.2/terraform_1.12.2_linux_arm64.zip &&
            unzip terraform_1.12.2_linux_arm64.zip -d /usr/bin &&
            chmod +x /usr/bin/terraform &&
            rm terraform_1.12.2_linux_arm64.zip
        "
}

install_terragrunt() {
    local terragrunt_bin="/usr/bin/terragrunt"
    proot-distro login alpine -- bash -c "[ -f '$terragrunt_bin' ]" 2>/dev/null && { log "Terragrunt already installed"; return 0; }
    
    execute_command "Install Terragrunt in proot" \
        proot-distro login alpine -- bash -c "
            curl -LO 'https://github.com/gruntwork-io/terragrunt/releases/download/v${TERRAGRUNT_VERSION}/terragrunt_linux_arm64' &&
            mv terragrunt_linux_arm64 /usr/bin/terragrunt &&
            chmod +x /usr/bin/terragrunt
        "
}

install_sdkman() {
    [ -d "$HOME/.sdkman" ] && { log "SDKMan already installed"; return 0; }
    execute_command "Install SDKMan" curl -s "https://get.sdkman.io" | bash
    [ -f "$HOME/.sdkman/bin/sdkman-init.sh" ] && {
        source "$HOME/.sdkman/bin/sdkman-init.sh"
        execute_command "Install Java" sdk install java
        execute_command "Install Gradle" sdk install gradle
    }
}

install_nvm() {
    command_exists npm && { 
        execute_command "Install corepack" npm install -g corepack
        execute_command "Enable corepack" corepack enable
        return 0
    }
    [ -d "$HOME/.nvm" ] && { log "NVM already installed"; return 0; }
    execute_command "Install NVM" curl -o- "https://raw.githubusercontent.com/nvm-sh/nvm/v${NVM_VERSION}/install.sh" | bash
    [ -f "$HOME/.nvm/nvm.sh" ] && {
        unset PREFIX  # For Android
        source "$HOME/.nvm/nvm.sh"
        execute_command "Install Node LTS" nvm install --lts
        execute_command "Update npm" npm install -g npm@latest
        execute_command "Install corepack" npm install -g corepack
        execute_command "Enable corepack" corepack enable
    }
}

install_pyenv() {
    command_exists pip && { log "Python/pip already available"; return 0; }
    [ -d "$HOME/.pyenv" ] && { log "pyenv already installed"; return 0; }
    execute_command "Install pyenv" curl -fsSL https://pyenv.run | bash
    [ -d "$HOME/.pyenv" ] && {
        export PATH="$PATH:$HOME/.pyenv/bin"
        execute_command "Install Python $PYTHON_VERSION" pyenv install "$PYTHON_VERSION"
        execute_command "Set Python global" pyenv global "$PYTHON_VERSION"
        execute_command "Upgrade pip" pip install --upgrade pip
    }
}

install_azure_cli() {
    command_exists pip || { log_error "pip required for Azure CLI"; return 1; }
    [ -d "$HOME/.azure" ] && { log "Azure CLI already installed"; return 0; }
    execute_command "Install Azure CLI" pip install azure-cli
}

install_1password_cli() {
    local op_bin="/usr/bin/op"
    proot-distro login alpine -- bash -c "[ -f '$op_bin' ]" 2>/dev/null && { log "1Password CLI already installed"; return 0; }
    
    execute_command "Install 1Password CLI in proot" \
        proot-distro login alpine -- bash -c "
            wget 'https://cache.agilebits.com/dist/1P/op2/pkg/v${ONEPASSWORD_VERSION}/op_linux_arm64_v${ONEPASSWORD_VERSION}.zip' -O op.zip &&
            unzip -d op op.zip &&
            mv op/op /usr/bin/ &&
            rm -rf op.zip op &&
            chmod +x /usr/bin/op
        "
}

configure_dns_android() {
    log "Configuring DNS for Android..."
    local rcfile="/data/data/com.termux/files/usr/etc/resolv.conf"
    execute_command "Configure DNS servers" bash -c "
        echo 'nameserver 8.8.8.8' > '$rcfile'
        echo 'nameserver 8.8.4.4' >> '$rcfile'
        echo 'nameserver 1.1.1.1' >> '$rcfile'
    "
}

configure_neovim() {
    log "Configuring NeoVim with AstroVim..."
    local nvim_path="$HOME/.config/nvim"
    [ -d "$nvim_path" ] && { log "NeoVim already configured"; return 0; }
    
    mkdir -p "$(dirname "$nvim_path")"
    execute_command "Clone AstroVim template" \
        git clone --depth 1 https://github.com/AstroNvim/template "$nvim_path"
    execute_command "Remove template git history" rm -rf "$nvim_path/.git"
}

# Main installation function
main() {
    log "Starting Android/Termux dependencies installation..."
    
    # Android-specific setup
    execute_command "Setup Termux storage" termux-setup-storage
    
    # Update package list
    execute_command "Update package list" apt update
    
    # Install system packages
    install_packages "requirements" "${REQUIREMENTS[@]}"
    install_packages "hardware monitoring" "${HARDWARE[@]}"
    install_packages "utilities" "${UTILITIES[@]}"
    install_packages "programming languages" "${LANGUAGES[@]}"
    
    # Install development tools
    install_oh_my_zsh
    install_gvm
    install_wrapper
    install_terra
    install_terraform
    install_terragrunt
    install_sdkman
    install_nvm
    install_pyenv
    install_azure_cli
    install_1password_cli
    
    # Configure Android-specific settings
    configure_dns_android
    configure_neovim
    
    log "Android dependencies installation completed successfully!"
}

# Run main function
main "$@"