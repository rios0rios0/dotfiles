{{- template "helpers.tmpl" . -}}

{{- define "gpg-entry-handler" -}}

# read the GPG name and private key from 1Password
gpgName="{{ onepasswordRead (list "op://Private/" .gpgEntry.value "/title" | join "") "my" }}"
gpgPassword="{{ trimAll "`" (onepasswordRead (list "op://Private/" .gpgEntry.value "/password" | join "") "my") }}"
gpgPrivateKey="{{ trimAll "`" (onepasswordRead (list "op://Private/" .gpgEntry.value "/private.key" | join "") "my") }}"

# create the private key file
privateKeyFilePath="$gpgFolderPath/$gpgName"
echo "Creating private key file: \"$privateKeyFilePath\"..."
echo "$gpgPrivateKey" > "$privateKeyFilePath"

# import GPG keys into GPG keyring
gpg --batch --passphrase "$gpgPassword" --import "$privateKeyFilePath"

echo "Private key file has been created successfully."

{{- end -}}

#!/bin/bash

# define the path to the ".gpg" folder
gpgFolderPath="$HOME/.gpg"

# ensure the ".gpg" folder exists
mkdir -p $gpgFolderPath

{{- template "helpers.gpgEntries" . }}

# cleanup the ".gpg" folder
rm -rf $gpgFolderPath