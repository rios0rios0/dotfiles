{{ template "helpers" . }}

{{- define "pem-entry-handler" -}}

# read the PEM name and private key from 1Password
$pemName = "{{ .pemName }}"
$pemPrivateKey = "{{ trimAll "`" (onepasswordRead (list "op://Private/" .pemEntry.value "/notes" | join "") "my") }}"

# create the private key file
$privateKeyFilePath = "$sshFolderPath\$pemName"
Write-Output "Creating private key file: `"$privateKeyFilePath`"..."
Set-Content -Path $privateKeyFilePath -Value $pemPrivateKey -Force

{{- end -}}

# define the path to the .ssh folder
$sshFolderPath = "$HOME\.ssh"

# ensure the .ssh folder exists
if (-Not (Test-Path -Path $sshFolderPath)) {
    New-Item -ItemType Directory -Path $sshFolderPath
}

{{- template "helpers.allPemEntries" . }}