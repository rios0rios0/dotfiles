# define the path to the .ssh folder
$sshFolderPath = "$HOME\.ssh"

# ensure the .ssh folder exists
if (-Not (Test-Path -Path $sshFolderPath)) {
    New-Item -ItemType Directory -Path $sshFolderPath
}

{{- range (onepassword "Active SSHs" "personal" "my").fields }}
{{-      if (eq .type "REFERENCE") }}

# read the SSH name and public key from 1Password
$sshName = "{{ onepasswordRead (printf "op://Private/%s/title" .value) "my" }}"
$sshPublicKey = "{{ onepasswordRead (printf "op://Private/%s/public key" .value) "my" }}"

# create the public key file
$publicKeyFilePath = "$sshFolderPath\$sshName.pub"
Write-Output "Creating public key file: `"$publicKeyFilePath`"..."
Set-Content -Path $publicKeyFilePath -Value $sshPublicKey -Force

{{-      end -}}
{{- end }}
