{{- /*
  This file contains reusable template helpers to avoid repetition across templates.
  Use these helpers by including them like: {{ template "helpers.deviceName" . }}
*/ -}}

{{- /* Get the normalized device name for device matching */ -}}
{{- define "helpers.deviceName" -}}
{{- default .chezmoi.hostname (env "CHEZMOI_DEVICE" | replaceAllRegex " " "-" | trim) | lower -}}
{{- end -}}

{{- /* Get the cleaned username */ -}}
{{- define "helpers.username" -}}
{{- (trimPrefix (upper .chezmoi.hostname) .chezmoi.username) | replace "\\" "" -}}
{{- end -}}

{{- /* 
  Iterate over SSH entries for the current device.
  The template calling this should define what to do with each entry.
  Context variables available in the calling template:
  - $sshName: the full SSH name (device@account)
  - $sshEntry: the 1Password entry reference
*/ -}}
{{- define "helpers.sshEntries" -}}
{{- $deviceName := template "helpers.deviceName" . -}}
{{- range (onepassword "Active SSHs" "personal" "my").fields -}}
  {{- if (eq .type "REFERENCE") -}}
    {{- $sshName := onepasswordRead (list "op://Private/" .value "/title" | join "") "my" | trim -}}
    {{- $parts := split "@" $sshName -}}
    {{- $device := index $parts "_0" -}}
    {{- if eq $device $deviceName -}}
      {{- $sshEntry := . -}}
      {{- template "ssh-entry-handler" (dict "sshName" $sshName "sshEntry" $sshEntry "context" $) -}}
    {{- end -}}
  {{- end -}}
{{- end -}}
{{- end -}}

{{- /* 
  Iterate over ALL SSH entries (no device filtering).
  The template calling this should define what to do with each entry.
  Context variables available in the calling template:
  - $sshName: the full SSH name (device@account)
  - $sshEntry: the 1Password entry reference
*/ -}}
{{- define "helpers.allSshEntries" -}}
{{- range (onepassword "Active SSHs" "personal" "my").fields -}}
  {{- if (eq .type "REFERENCE") -}}
    {{- $sshName := onepasswordRead (list "op://Private/" .value "/title" | join "") "my" | trim -}}
    {{- $sshEntry := . -}}
    {{- template "ssh-entry-handler" (dict "sshName" $sshName "sshEntry" $sshEntry "context" $) -}}
  {{- end -}}
{{- end -}}
{{- end -}}

{{- /* 
  Iterate over PEM entries for the current device.
  The template calling this should define what to do with each entry.
  Context variables available in the calling template:
  - $pemName: the full PEM name (device@account)
  - $pemEntry: the 1Password entry reference
*/ -}}
{{- define "helpers.pemEntries" -}}
{{- $deviceName := template "helpers.deviceName" . -}}
{{- range (onepassword "Active PEMs" "personal" "my").fields -}}
  {{- if (eq .type "REFERENCE") -}}
    {{- $pemName := onepasswordRead (list "op://Private/" .value "/title" | join "") "my" | trim -}}
    {{- $parts := split "@" $pemName -}}
    {{- $device := index $parts "_0" -}}
    {{- if eq $device $deviceName -}}
      {{- $pemEntry := . -}}
      {{- template "pem-entry-handler" (dict "pemName" $pemName "pemEntry" $pemEntry "context" $) -}}
    {{- end -}}
  {{- end -}}
{{- end -}}
{{- end -}}

{{- /* 
  Iterate over GPG entries.
  The template calling this should define what to do with each entry.
  Context variables available in the calling template:
  - $gpgEntry: the 1Password entry reference
*/ -}}
{{- define "helpers.gpgEntries" -}}
{{- range (onepassword "Active GPGs" "personal" "my").fields -}}
  {{- if (eq .type "REFERENCE") -}}
    {{- $gpgEntry := . -}}
    {{- template "gpg-entry-handler" (dict "gpgEntry" $gpgEntry "context" $) -}}
  {{- end -}}
{{- end -}}
{{- end -}}