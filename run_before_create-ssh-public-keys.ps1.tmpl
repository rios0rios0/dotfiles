# Define the path to the .ssh folder
$sshFolderPath = "$HOME\.ssh"

# Ensure the .ssh folder exists
if (-Not (Test-Path -Path $sshFolderPath)) {
    New-Item -ItemType Directory -Path $sshFolderPath
}

# Iterate through entries in 1Password
{{ range (onepassword "Active SSHs" "personal" "my").fields -}}
{{      if (eq .type "REFERENCE") -}}
$sshName = "{{ onepasswordRead (list "op://Private/" .value "/title" | join "") "my" }}"
$sshPublicKey = "{{ onepasswordRead (list "op://Private/" .value "/public key" | join "") "my" }}"

# Create the public key file
$publicKeyFilePath = "$sshFolderPath\$sshName.pub"
Write-Output "Creating public key file: `"$publicKeyFilePath`"..."
Set-Content -Path $publicKeyFilePath -Value $sshPublicKey -Force
{{      end -}}
{{ end }}
