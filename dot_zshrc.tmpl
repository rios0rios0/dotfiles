###### P10k Instant Prompt (MUST BE AT THE TOP) #########################################################################
# enable Powerlevel10k instant prompt. Should stay close to the top of ~/.zshrc.
# Initialization code that may require console input (password prompts, [y/n]
# confirmations, etc.) must go above this block; everything else may go below.
# Only load instant prompt if we have a real TTY (prevents errors in non-TTY contexts like zsh -i -c)
if [[ -t 0 && -t 1 && -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
  source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi

###### Environment ######################################################################################################
export LOCAL_ROOT="$HOME/.local"
localBinPath="$LOCAL_ROOT/bin"
if [ -d "$localBinPath" ]; then
    export LOCAL_BIN_PATH="$localBinPath"
    export PATH="$LOCAL_BIN_PATH:$PATH"
fi

# it solves the java options problem in many places
unset _JAVA_OPTIONS

{{- if eq .chezmoi.os "android" }}
export CHEZMOI_DEVICE="$(getprop ro.product.model)"

# TODO: nvm is not compatible with the "PREFIX" environment variable. This is generated because of ZSH plugins
unset PREFIX
{{- end }}

###### ZINIT CONFIGURATION ##############################################################################################
ZINIT_HOME="${XDG_DATA_HOME:-${HOME}/.local/share}/zinit/zinit.git"
[ ! -d $ZINIT_HOME ] && mkdir -p "$(dirname $ZINIT_HOME)"
[ ! -d $ZINIT_HOME/.git ] && git clone https://github.com/zdharma-continuum/zinit.git "$ZINIT_HOME"
source "${ZINIT_HOME}/zinit.zsh"

export LESS_TERMCAP_mb=$'\e[1;32m'
export LESS_TERMCAP_md=$'\e[1;32m'
export LESS_TERMCAP_me=$'\e[0m'
export LESS_TERMCAP_se=$'\e[0m'
export LESS_TERMCAP_so=$'\e[01;33m'
export LESS_TERMCAP_ue=$'\e[0m'
export LESS_TERMCAP_us=$'\e[1;4;31m'

###### ZINIT Plugins ###############################################################
# TODO: this should be in another file before configuration, installing those dependencies
######################################################
# only load powerlevel10k in TTY environments to avoid gitstatus errors
if [[ -t 0 && -t 1 ]]; then
    zinit light romkatv/powerlevel10k
    [[ ! -L $HOME/.oh-my-zsh/custom/themes/powerlevel10k ]] && ln -sf $HOME/.local/share/zinit/plugins/romkatv---powerlevel10k $HOME/.oh-my-zsh/custom/themes/powerlevel10k
fi
######################################################
######################################################
zinit light larkery/zsh-histdb
[[ ! -L $HOME/.oh-my-zsh/custom/plugins/zsh-histdb ]] && ln -sf $HOME/.local/share/zinit/plugins/larkery---zsh-histdb $HOME/.oh-my-zsh/custom/plugins/zsh-histdb
source $HOME/.oh-my-zsh/custom/plugins/zsh-histdb/sqlite-history.zsh
autoload -Uz add-zsh-hook
source $HOME/.oh-my-zsh/custom/plugins/zsh-histdb/histdb-interactive.zsh
bindkey '^r' _histdb-isearch
#bindkey '^[[A' _histdb-isearch # TODO: it didn't work
#bindkey '^[[B' _histdb-isearch # TODO: it didn't work

_zsh_autosuggest_strategy_histdb_top() {
    local query="
        SELECT commands.argv FROM history
        LEFT JOIN commands ON history.command_id = commands.rowid
        LEFT JOIN places ON history.place_id = places.rowid
        WHERE commands.argv LIKE '$(sql_escape $1)%'
        GROUP BY commands.argv, places.dir
        ORDER BY places.dir != '$(sql_escape $PWD)', COUNT(*) DESC
        LIMIT 1
    "
    suggestion=$(_histdb_query "$query")
}

ZSH_AUTOSUGGEST_STRATEGY=histdb_top
######################################################
######################################################
zinit light zsh-users/zsh-completions
######################################################
######################################################
zinit light zsh-users/zsh-autosuggestions
######################################################
######################################################
zinit light zdharma-continuum/fast-syntax-highlighting
{{- if eq .chezmoi.os "android" }}
######################################################
######################################################
# generate slug from CHEZMOI_DEVICE
slug=$(printf '%s' "$CHEZMOI_DEVICE" \
  | sed -e 's/^[[:space:]]*//' \
        -e 's/[[:space:]]*$//' \
        -e 's/[[:space:]]\+/-/g' \
  | tr '[:upper:]' '[:lower:]')

# collect only non-.pub identities
typeset -a sshIdentities
for key in "$HOME/.ssh/$slug"*(.N); do
  if [[ $key != *.pub ]]; then
    sshIdentities+=${key:t}
  fi
done

# feed them to the OMZ ssh-agent plugin
zstyle ':omz:plugins:ssh-agent' identities $sshIdentities
######################################################
{{- end }}

###### P10k CONFIGURATION ###############################################################################################
# Only load p10k config in TTY environments
[[ -t 0 && -t 1 && -f ~/.p10k.zsh ]] && source ~/.p10k.zsh


###### ZSH CONFIGURATION ################################################################################################
setopt HIST_FIND_NO_DUPS
setopt HIST_IGNORE_ALL_DUPS

export ZSH="$HOME/.oh-my-zsh"
# only use powerlevel10k theme in TTY environments to avoid gitstatus errors
if [[ -t 0 && -t 1 ]]; then
    ZSH_THEME="powerlevel10k/powerlevel10k"
else
    ZSH_THEME="robbyrussell"  # fallback theme for non-TTY
fi
# true = if pasting URLs and other text is messed up
DISABLE_MAGIC_FUNCTIONS="true"

plugins=(
  common-aliases zsh-histdb # history history-substring-search (history managed by "histdb")
  colorize colored-man-pages command-not-found vim-interaction
  1password
  nmap ssh
  {{- if eq .chezmoi.os "android" }}
  ssh-agent
  {{- end }}
  aws azure heroku terraform helm
  kubectl kubectx
  git github git-flow git-flow-avh git-hubflow
  golang
  mvn gradle spring
  node npm yarn nvm react-native
  composer laravel5 symfony6
  python pip pipenv virtualenv pep8
)

# conditionally add docker plugins if docker is available (avoids errors when Docker Desktop is not running)
if command -v docker &>/dev/null; then
  plugins+=(docker docker-compose)
fi

# for a full list of active aliases, run `alias`
source $ZSH/oh-my-zsh.sh


###### Toolbox ##########################################################################################################
###### General #####################################################################
export TOOLS_DIR="$HOME/Development/Tools"
export SPEEDTEST="$TOOLS_DIR/Speedtest"
export CYCLONEDX="$TOOLS_DIR/Cyclonedx"

alias tools="cd $TOOLS_DIR"
alias speed1="$SPEEDTEST/speedtest"
alias speed2="python $SPEEDTEST/speedtest-cli --bytes"
alias cydx="$CYCLONEDX/cyclonedx-cli"

###### Files #######################################################################
{{- if ne .chezmoi.os "android" }}
# only run background script in interactive shells
[[ -o interactive ]] && $HOME/.scripts/linux-toolbox-watch-compress-folders.sh &>/dev/null &
{{- end }}

alias top5size='sudo du -hs * | sort -rh | head -5'
clear-h() {
  rm -rf ~/.bash_history
  rm -rf ~/.bashrc.original
  rm -rf ~/.lesshst
  rm -rf ~/.python_history
  rm -rf ~/.shell.pre-oh-my-zsh
  rm -rf ~/.sudo_as_admin_successful
  rm -rf ~/.zcompdump*
  rm -rf ~/.zshrc.pre-oh-my-zsh
}
clear-logs() {
  sudo find /var/log -name "*.log" -type f -mtime +5 -exec rm -f {} \;
}
pdf-join() {
  pdftk $1 $2 cat output result.pdf
}
pdf-to-jpg() {
  convert -density 300 -quality 100 $1 ${1%.*}.jpg
}
jpg-to-pdf() {
  convert *.jpg -auto-orient pictures.pdf
}
video-to-mp4() {
  ffmpeg -i $1 ${1%.*}.mp4
}

###### EZA #########################################################################
alias ls="eza -1 --classify --group-directories-first"
alias ll="eza --long --header --classify --icons --group-directories-first --no-permissions"
alias lp="eza --long --header --classify --icons --group-directories-first"
alias la="eza -a --long --header --classify --icons --group-directories-first"
alias lt="eza --tree --long --header --classify --icons --group-directories-first"
alias t="eza --tree --header --classify --icons --group-directories-first"

###### ASCIINema ###################################################################
alias record="PYTHONPATH=$TOOLS_DIR/asciinema python -m asciinema rec"
alias play="PYTHONPATH=$TOOLS_DIR/asciinema python -m asciinema play"


###### Engineering ######################################################################################################
###### Cloud #######################################################################
aws-prof() { export AWS_PROFILE=$1 }
azm-subs() { az account set --subscription $1 }
{{- if eq .chezmoi.os "android" }}
alias terraw="wrapper terra"            # when called, the other 2 will be inside proot already
alias terraformw="wrapper terraform"    # useful when needed to call alone (it might not be needed)
alias terragruntw="wrapper terragrunt"  # useful when needed to call alone (it might not be needed)
{{- end }}

###### K8s #########################################################################
export KREW_BIN="${KREW_ROOT:-$HOME/.krew}/bin" && export PATH=$KREW_BIN:$PATH

source "$HOME/.scripts/linux-engineering-detect-kube-config-files.sh"

###### Docker ######################################################################
# only load docker completions and aliases if docker is available (avoids errors when Docker Desktop is not running)
if command -v docker &>/dev/null; then
  zinit snippet "https://github.com/docker/cli/blob/master/contrib/completion/zsh/_docker"
fi
source "$HOME/.scripts/linux-engineering-docker-aliases.sh"

###### GoLang ######################################################################
export GOLANG_BIN="$HOME/go/bin" && export PATH="$GOLANG_BIN:$PATH"

gvmRoot="$HOME/.gvm"
if [ -d "$gvmRoot" ]; then
    # always source GVM first to make the gvm command available
    [[ -s "$gvmRoot/scripts/gvm" ]] && source "$gvmRoot/scripts/gvm"

    # detect and use Go version from go.mod if it exists (only in interactive shells)
    if [[ -o interactive ]] && [ -f "$(pwd)/go.mod" ]; then
        goVersion=$(grep -E '^go [0-9]+\.[0-9]+' "$(pwd)/go.mod" | awk '{print $2}')
        if [ -n "$goVersion" ]; then
            goVersionFull="go$goVersion"

            # check if gvm command is available and the version is installed
            if command -v gvm &>/dev/null; then
                if ! gvm list 2>/dev/null | grep -q "$goVersionFull"; then
                    echo "Installing Go version $goVersionFull..."
                    gvm install "$goVersionFull" -B 2>/dev/null || echo "Warning: Failed to install $goVersionFull"
                fi

                # use the detected version (suppress errors if version doesn't exist)
                gvm use "$goVersionFull" 2>/dev/null || true
            fi
        fi
    fi
fi

###### Java ########################################################################
export ANDROID_SDK_ROOT="$HOME/Android/Sdk"
export PATH="$ANDROID_SDK_ROOT/emulator:$ANDROID_SDK_ROOT/platform-tools/adb:$PATH"

sdkmanRoot="$HOME/.sdkman"
if [ -d "$sdkmanRoot" ]; then
    export SDKMAN_DIR="$sdkmanRoot"
    [[ -s "$sdkmanRoot/bin/sdkman-init.sh" ]] && source "$sdkmanRoot/bin/sdkman-init.sh"
fi

###### Node ########################################################################
nvmRoot="$HOME/.nvm"
if [ -d "$nvmRoot" ]; then
    export NVM_HOME="$nvmRoot"
    [ -s "$NVM_HOME/nvm.sh" ] && \. "$NVM_HOME/nvm.sh"
    [ -s "$NVM_HOME/bash_completion" ] && \. "$NVM_HOME/bash_completion"

    # if .nvmrc exists, install (if needed) and use that version.
    if [ -f "$(pwd)/.nvmrc" ]; then
        nvmrc_version=$(tr -d '\r\n' < .nvmrc)
        if ! nvm ls "$nvmrc_version" >/dev/null 2>&1; then
            echo "Installing Node version $nvmrc_version..."
            nvm install "$nvmrc_version"
        fi
        nvm use "$nvmrc_version"
    # otherwise, if this directory looks like a Node project, try to use current/default node.
    elif [ -f "$(pwd)/package.json" ]; then
        nvm use || true
    fi
fi

###### Python ######################################################################
pyenvRoot="$HOME/.pyenv"
if [ -d "$pyenvRoot" ]; then
    export PYENV_ROOT="$pyenvRoot"
    [[ -d $PYENV_ROOT/bin ]] && export PATH="$PYENV_ROOT/bin:$PATH"
    eval "$(pyenv init -)"
fi

###### Rust ########################################################################
cargoRoot="$HOME/.cargo"
if [ -d "$cargoRoot" ]; then
    export CARGO_ROOT="$cargoRoot"
    [[ -d $CARGO_ROOT/bin ]] && export PATH="$CARGO_ROOT/bin:$PATH"
fi

###### Workspace Information #######################################################
{{- if ne .chezmoi.os "android" }}
source "$HOME/.scripts/linux-engineering-workspace-information.sh"
{{- end }}
